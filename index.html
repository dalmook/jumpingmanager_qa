<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#ffffff" />
  <title>점핑배틀 화성병점점</title>

  <link rel="stylesheet" href="styles.css" />
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/app-192.png" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />  

  <!-- Firebase SDK -->
  <script defer src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="app.js"></script>
</head>
<body class="ios">
  <!-- iOS Large Title Header -->
  <header class="ios-header">
    <div class="safe-pad"></div>

    <div class="header-inner">
      <div class="header-top">
        <div class="brand">
          <span class="logo-dot"></span>
          <span class="brand-text">점핑배틀 화성병점점</span>
        </div>

        <div class="auth-area">
          <!-- 로그아웃 전(비회원/미인증) -->
          <div id="signedOut" class="auth-row">
            <!-- 관리자: 이메일, 손님: 휴대폰 01012345678 -->
            <input id="loginEmail" type="text" inputmode="text" placeholder="휴대폰 01012345678" />
            <input id="loginPass" type="password" placeholder="비밀번호" />
            <button id="btnLogin" class="btn primary">로그인</button>
            <button id="btnSignup" class="btn ghost">회원가입</button>
          </div>

          <!-- 로그인 상태에서만 노출 -->
          <div id="signedIn" class="auth-row hidden">
            <button id="btnLogout" class="btn small ghost logout-top">로그아웃</button>
          </div>
        </div>
      </div>

      <!-- 상단 큰 QR (손님용) -->
      <div id="selfBigQR" class="big-qr"></div>
    </div>
  </header>

<main class="app-shell">
  <!-- 관리자 화면 -->
  <section id="adminPanel" class="panel hidden">
    <div class="admin-grid">
      <!-- 좌: 고정 사이드바(회원 목록) -->      
      <aside class="card glass stick-left sidebar">
        <div class="section-head">
          <h2>회원 목록</h2>
        </div>

        <div class="search-row">
          <input id="searchPhone" placeholder="휴대폰 전체/끝 4자리" inputmode="numeric" />
          <button id="btnSearch" class="btn ghost">검색</button>
          <button id="btnClearSearch" class="btn ghost small">✕</button>
          <button id="btnQRScan" class="btn small highlight">QR 스캔</button>
        </div>


        <div class="quick-register">
          <details>
            <summary>빠른 등록/수정</summary>
            <div class="grid three">
              <input id="regName" placeholder="이름" />
              <input id="regPhone" placeholder="휴대폰번호" inputmode="numeric" />
              <input id="regTeam" placeholder="팀명" />
              <button id="btnRegister" class="btn primary">등록/수정</button>
            </div>
          </details>
        </div>

        <div id="adminList" class="list mt8" aria-live="polite"></div>
      </aside>

<!-- 우: 상세(정돈 버전) -->
<section id="memberSection" class="card glass hidden admin-detail">
  <div class="section-head">
    <h2>회원 상세</h2>
  </div>

  <div class="member-card" id="memberCard">
    <!-- KPI 요약 -->
    <div class="member-head">
      <div class="stats">
        <div class="stat pill">
          <div class="label">스탬프(10)</div><div id="mStamp" class="value">0</div>
        </div>
        <div class="stat pill">
          <div class="label">스탬프적립쿠폰</div><div id="mFree" class="value">0</div>
        </div>
        <div class="stat pill">
          <div class="label">평일이용권</div><div id="mFreeWk" class="value">0</div>
        </div>
        <div class="stat pill">
          <div class="label">슬러시 무료권</div><div id="mFreeSl" class="value">0</div>
        </div>
        <div class="stat pill highlight">
          <div class="label">다회권 잔여</div><div id="mPassTotal" class="value">0</div>
        </div>
      </div>
    </div>

    <!-- 스탬프 진행 막대 -->
    <div class="progress">
      <div id="stampDots" class="dots"></div>
    </div>

    <!-- 1) 기본 정보 (접기/펼치기 가능) -->
      <details class="section-card tidy-card" id="profileSection">
        <summary class="section-row">
          <div class="group-title-wrap">
            <span class="toggle-icon">▶</span>
            <h3 class="group-title">기본 정보</h3>
          </div>
          <button id="btnSaveProfile" class="btn primary small">프로필 저장</button>
        </summary>
        <div class="grid three">
        <label for="editName">이름</label>
        <input id="editName" placeholder="이름" />
    
        <label for="editTeam">팀명</label>
        <input id="editTeam" placeholder="팀명" />
    
        <label for="editEmail">이메일</label>
        <input id="editEmail" placeholder="이메일" />
    
        <label for="editCar">차량번호</label>
        <input id="editCar" placeholder="차량번호 (선택)" />
    
        <label for="editNote">비고</label>
        <input id="editNote" placeholder="비고 (선택)" />
    
        <label>전화번호</label>
        <input disabled value="전화번호는 문서 키 기준" />
      </div>
    </details>


<!-- 2) 방문/스탬프/스탬프적립쿠폰 -->
<section class="section-card">
  <h3 class="group-title">방문스탬프·슬러시 관리</h3>

  <div class="grid two mt8">
    <!-- ✅ 왼쪽: 스탬프 조정 -->
    <div class="panel-sub">
      <h4 class="sub-title">스탬프 조정</h4>
      <div class="field-row">
        <input id="stampDelta" type="number" min="1" step="1" value="1" class="w110" />
        <div class="btn-group">
          <button id="btnAddStampN" class="btn primary">+</button>
          <button id="btnSubStampN" class="btn ghost">-</button>
        </div>
      </div>
      <p class="hint">10개마다 <b>무료권 1매 자동 적립</b></p>
    </div>

    <!-- ✅ 오른쪽: 슬러시 무료권 -->
    <div class="panel-sub">
      <h4 class="sub-title">슬러시 무료권</h4>
      <div class="field-row">
        <input id="freeSlDelta" type="number" min="1" step="1" value="1" class="w110" />
        <div class="btn-group">
          <button id="btnAddFreeSlN" class="btn primary">+</button>
          <button id="btnSubFreeSlN" class="btn ghost">-</button>
        </div>
      </div>
    </div>
  </div>
</section>




    <!-- 3) 다회권 관리 -->
    <section class="section-card tidy-card" id="passCard">
      <h3 class="group-title">다회권 관리</h3>

      <!-- 프리셋 -->
      <div class="btn-row wrap">
        <button id="passPreset10"  class="btn ghost small">10회권</button>
        <button id="passPreset20"  class="btn ghost small">20회권</button>
        <button id="passPresetFree" class="btn ghost small">스탬프적립쿠폰</button>
        <button id="passPresetWk"   class="btn ghost small">평일이용권</button>
      </div>

      <!-- 추가 폼 -->
      <div class="field-group">
        <label class="field-label">권종 추가</label>
        <div class="field-grid">
          <input id="passName"  placeholder="권종명 (예: 10회권, 스탬프적립쿠폰, 평일이용권)" />
          <input id="passCount" type="number" min="1" step="1" value="1" />
          <input id="passExpire" type="date" />
          <button id="btnAddPass" class="btn primary">추가</button>
        </div>
      </div>

      <!-- 선택 후 증감/환불 -->
      <div class="field-group">
        <label class="field-label" for="passSelect">보유 권종 조정</label>
        <div class="field-grid">
          <select id="passSelect"></select>
          <input id="passDelta" type="number" min="1" step="1" value="1" />
          <div class="btn-group">
            <!-- +N 먼저, primary 색상 -->
            <button id="btnRefundPassN" class="btn primary">+</button>
            <!-- -N 나중, ghost 색상 -->
            <button id="btnUsePassN"    class="btn ghost">-</button>
          </div>
        </div>
      </div>
      

      <!-- 삭제는 위험 작업으로 아래에서 -->
    </section>

    <!-- 4) 리스트 두 칸: 보유 다회권 / 스테이지 -->
    <div class="grid two mt16">
      <section class="section-card">
        <h3>보유 다회권</h3>
        <div id="passList" class="list small"></div>
      </section>
    <!-- ✅ 스테이지 기록: 전체폭 + 접기/펼치기 (기본 접힘) -->
    <details class="section-card tidy-card stage-full" id="stageSection">
      <summary class="section-row">
        <div class="group-title-wrap">
          <span class="toggle-icon">▶</span>
          <h3 class="group-title">레벨 기록</h3>
        </div>
        <button id="btnSaveStages" class="btn primary small">스테이지 저장</button>
      </summary>
    
      <div id="stageList" class="list small mt8"></div>
    </details>
    </div>

    <!-- ✅ 활동로그: 접기/펼치기 (기본 접힘) -->
    <details class="section-card tidy-card" id="logsSection">
      <summary class="section-row">
        <div class="group-title-wrap">
          <span class="toggle-icon">▶</span>
          <h3 class="group-title">활동 로그</h3>
        </div>
        <!-- 버튼은 그대로 유지 (ID 변경 금지) -->
        <div class="row">
          <button id="btnReloadLogs" class="btn small">새로고침</button>
          <button id="btnMoreLogs"   class="btn ghost small">더 보기</button>
        </div>
      </summary>
    
      <div id="logList" class="list small"></div>
    </details>


    <!-- 6) 위험 작업 (완전히 분리) -->
    <section class="danger-zone section-card tidy-danger">
      <div class="row wrap gap8">
        <button id="btnResetStamp"  class="btn danger">스탬프 0</button>
        <button id="btnDeletePass"  class="btn danger">선택권 삭제</button>
        <button id="btnDeleteMember" class="btn danger">회원 삭제</button>
        <span class="muted">※ 삭제 시 로그 서브컬렉션은 남습니다</span>
      </div>
    </section>
  </div>
</section>
</div>
</section>

    <!-- ========================= -->
    <!-- 손님 화면 -->
    <!-- ========================= -->
    <section id="memberSelf" class="panel hidden">
      <div class="card ios-card">
        <!-- 탭 콘텐츠 -->
        <div class="self-tabs">
       <div id="selfTab-summary" class="tabpane active">
        <div id="selfCard" class="member-card compact"></div>
        <!-- 귀여운 배경 버블(장식) -->
        <div class="kawaii-bubbles" aria-hidden="true">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
            <div id="selfCard" class="member-card compact"></div>
          </div>

          <div id="selfTab-passes" class="tabpane">
            <div class="section-card">
              <h3>보유 다회권</h3>
              <div id="selfPassList" class="list small"></div>
            </div>
          </div>

          <div id="selfTab-logs" class="tabpane">
            <div class="section-card">
              <h3>스테이지 기록</h3>
              <button id="btnViewStages" class="btn primary small">기록 보기</button>
              <div id="selfStageList" class="list small mt8"></div>
            </div>
          </div>
        </div>

        <!-- iOS 스타일 탭바 -->
        <nav class="tabbar">
          <button type="button" id="btnInstallPWA" class="tab btn highlight small hidden"
                  style="position:absolute; left:10px; transform:translateY(-44px);">
            ➕ 홈에 설치
          </button>          
          <button type="button" class="tab on" data-tab="summary">
            <span class="ico">🏠</span><span class="txt">요약</span>
          </button>
          <button type="button" class="tab" data-tab="passes">
            <span class="ico">🎫</span><span class="txt">다회권</span>
          </button>
          <button type="button" class="tab" data-tab="logs">
            <span class="ico">🧾</span><span class="txt">로그</span>
          </button>
        </nav>
      </div>
    </section>
  </main>

  <!-- QR 스캔 모달 -->
  <div id="qrModal" class="qr-modal hidden" role="dialog" aria-modal="true" aria-label="QR 스캔">
    <div class="qr-sheet">
      <video id="qrVideo" autoplay playsinline></video>
      <div class="row gap8 mt8">
        <button id="qrClose" class="btn ghost small">닫기</button>
        <span class="muted" id="qrHint">QR을 화면에 맞춰 주세요</span>
      </div>
    </div>
  </div>
<!-- 회원가입 모달 -->
<div id="signupModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
  <div class="modal-content card glass">
    <h2 id="signupTitle">회원가입</h2>

    <!-- ✅ 폼이 전부를 감쌉니다 -->
    <form id="signupForm" class="signup-form">
      <div class="grid">
        <input id="suName"  placeholder="이름 (필수)"        required />
        <input id="suPhone" placeholder="휴대폰번호 (필수)" inputmode="numeric" required />
        <input id="suPass"  type="password" placeholder="비밀번호 (필수)" required />
        <input id="suEmail" placeholder="이메일 (선택)" />
        <input id="suTeam"  placeholder="팀명 (선택)" />
        <input id="suCar"   placeholder="차량번호 (선택)" />
      </div>

      <!-- 개인정보 수집·이용 동의 -->
      <div style="grid-column:1 / -1; font-size:12px; line-height:1.5; margin-top:12px;">
        <p><b>개인정보 수집·이용 동의</b></p>
        <p>본 웹앱은 회원 관리와 이용 내역 기록을 위해 아래의 개인정보를 수집·이용합니다.</p>
        <ul style="margin:4px 0 8px 16px; padding:0;">
          <li>수집 항목: 이름, 휴대폰번호, 비밀번호, 이메일, 팀명, (선택) 차량번호</li>
          <li>이용 목적: 회원 식별, 서비스 이용 기록 관리, 무료권/스탬프 적립</li>
          <li>보유 기간: 회원 탈퇴 시 즉시 삭제</li>
        </ul>
        <label style="display:flex; align-items:center; gap:6px;">
          <input id="suAgree" type="checkbox" required />
          개인정보 수집·이용에 동의합니다.
        </label>
      </div>

      <div class="row mt16">
        <!-- ✅ type="submit" 으로 둡니다 -->
        <button id="btnDoSignup" type="submit" class="btn primary">가입하기</button>
        <button id="btnCancelSignup" type="button" class="btn ghost">취소</button>
      </div>
    </form>
  </div>
</div>


  <!-- 디버그 패널 -->
  <button id="__dbgToggle" class="dbg-toggle hidden">디버그</button>
  <div id="__dbgPanel" class="dbg-panel hidden">
    <div class="dbg-head">
      <b>로그</b>
      <div>
        <button id="__dbgCopy">복사</button>
        <button id="__dbgClear">지우기</button>
        <button id="__dbgClose">닫기</button>
      </div>
    </div>
    <textarea id="__dbgArea" readonly></textarea>
  </div>
   </div>
 </body>
<script>
  // --- Service Worker 등록 (오프라인/설치 가능 조건) ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    });
  }

  // --- A2HS(홈 화면 추가) 핸들 ---
  let deferredPrompt = null;
  const btn = document.getElementById('btnInstallPWA');

  // 크롬/안드로이드 계열: beforeinstallprompt 지원
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (btn) btn.classList.remove('hidden');
  });

  btn?.addEventListener('click', async () => {
    // iOS는 JS로 설치 팝업을 띄울 수 없음 → 안내만
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isIOS && isSafari) {
      alert('iPhone/iPad: 공유(⬆️) > 홈 화면에 추가로 설치하세요.');
      return;
    }
    if (!deferredPrompt) {
      // 이미 설치됐거나, 브라우저가 지원하지 않는 경우
      alert('설치가 불가능한 환경이거나 이미 설치됨으로 보입니다.');
      return;
    }
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      // 설치 성공 시 버튼 감춤
      btn.classList.add('hidden');
    }
    deferredPrompt = null;
  });

  // 설치 완료 이벤트(크롬)
  window.addEventListener('appinstalled', () => {
    btn?.classList.add('hidden');
  });
</script>
 </html>

</html>
